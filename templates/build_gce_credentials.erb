#!<%= ruby_path %>

require 'rubygems'
require 'oauth2'

def fog_compatible_credentials(client_id, client_secret, authorization_code, refresh_token)
%Q<:gce:
  :client_id: "#{client_id}"
  :client_secret: "#{client_secret}"
  :authorization_code: "#{authorization_code}"
  :refresh_token: "#{refresh_token}"
>
end

#Just include googles client id and client secret. We should generate one for Puppet Labs.
client_id = '1025389682001.apps.googleusercontent.com' 
client_secret = 'xslsVXhA7C8aOfSfb6edB6p6'

redirect_uri = 'urn:ietf:wg:oauth:2.0:oob'
scope = "https://www.googleapis.com/auth/compute https://www.googleapis.com/auth/compute.readonly https://www.googleapis.com/auth/devstorage.full_control https://www.googleapis.com/auth/devstorage.read_only https://www.googleapis.com/auth/devstorage.read_write https://www.googleapis.com/auth/devstorage.write_only https://www.googleapis.com/auth/userinfo.email"

puts "Building credentials file for Google Compute Oauth2"

client = OAuth2::Client.new(client_id, client_secret, :site => 'https://accounts.google.com', :token_url => '/o/oauth2/token', :authorize_url => '/o/oauth2/auth')
webpage = client.auth_code.authorize_url(:redirect_uri => redirect_uri, :scope => scope, :access_type => :offline)

puts "Go to this link to authorize the application:\n\n#{webpage}\n\n"
print "and enter the code you find after authorizing: "
code = STDIN.gets.chomp

token = client.auth_code.get_token(code, :redirect_uri => redirect_uri)
refresh_token = token.refresh_token

puts "client_id: #{client_id}"
puts "client_secret: #{client_secret}"
puts "authorization_code: #{code}"
puts "refresh_token: #{refresh_token}"

puts
print "Enter file for storing OAuth2 credentials [/tmp/oauth2_credentials.yml]: "
filename = File.expand_path(STDIN.gets.chomp.strip)
filename = "/tmp/oauth2_credentials.yml" if filename == ''

#Foreshadows upcoming GCE fog integration.
fog_credentials = fog_compatible_credentials(client_id, client_secret, code, refresh_token)
puts
puts fog_credentials
puts

puts "Storing credentials information in [#{filename}]..."
File.open(filename, 'w') {|f| f.puts fog_credentials }
